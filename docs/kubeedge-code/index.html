<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Kubeedge 代码解析（更新中） - 朱亚光的博客</title><meta name="Description" content="zhuyaguang blog"><meta property="og:title" content="Kubeedge 代码解析（更新中）" />
<meta property="og:description" content="kubeEdge 代码解析 目录 CHANGELOG 版本新特性 其他组件依赖比较大的三个组件，beehive，viaduct, mapper-framework beehive beehive是一个基于go channel的消息" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhuyaguang.github.io/kubeedge-code/" /><meta property="og:image" content="https://zhuyaguang.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-21T09:02:57+08:00" />
<meta property="article:modified_time" content="2024-03-21T09:02:57+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://zhuyaguang.github.io/logo.png"/>

<meta name="twitter:title" content="Kubeedge 代码解析（更新中）"/>
<meta name="twitter:description" content="kubeEdge 代码解析 目录 CHANGELOG 版本新特性 其他组件依赖比较大的三个组件，beehive，viaduct, mapper-framework beehive beehive是一个基于go channel的消息"/>
<meta name="application-name" content="朱亚光的博客">
<meta name="apple-mobile-web-app-title" content="朱亚光的博客"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://zhuyaguang.github.io/kubeedge-code/" /><link rel="prev" href="https://zhuyaguang.github.io/claude/" /><link rel="next" href="https://zhuyaguang.github.io/jetson-on-kubeedge-use-gpu/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Kubeedge 代码解析（更新中）",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/zhuyaguang.github.io\/kubeedge-code\/"
        },"genre": "posts","wordcount":  15221 ,
        "url": "https:\/\/zhuyaguang.github.io\/kubeedge-code\/","datePublished": "2024-03-21T09:02:57+08:00","dateModified": "2024-03-21T09:02:57+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "朱亚光"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="朱亚光的博客">朱亚光的博客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="/reading/"> 书单 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="朱亚光的博客">朱亚光的博客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="/reading/" title="">书单</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Kubeedge 代码解析（更新中）</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/zhuyaguang" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>朱亚光</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2024-03-21">2024-03-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 15221 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 31 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#目录">目录</a></li>
    <li><a href="#beehive">beehive</a>
      <ul>
        <li><a href="#model-包">model 包</a></li>
        <li><a href="#context-包">context 包</a></li>
        <li><a href="#channel-包">channel 包</a></li>
        <li><a href="#socket-包">socket 包</a>
          <ul>
            <li><a href="#context_socketgo">context_socket.go</a></li>
          </ul>
        </li>
        <li><a href="#corego">Core.go</a></li>
        <li><a href="#modulego">Module.go</a></li>
      </ul>
    </li>
    <li><a href="#cloudcore">CloudCore</a>
      <ul>
        <li><a href="#cloudhub">CloudHub</a>
          <ul>
            <li><a href="#cloudhub-启动流程">CloudHub 启动流程</a></li>
            <li><a href="#下行消息发送模式">下行消息发送模式</a></li>
            <li><a href="#边缘节点接入">边缘节点接入</a></li>
            <li><a href="#上下行消息分发">上下行消息分发</a></li>
          </ul>
        </li>
        <li><a href="#synccontroller">SyncController</a></li>
      </ul>
    </li>
    <li><a href="#edgehub">EdgeHub</a></li>
    <li><a href="#节点分组cloudstreamedgestream-模块">节点分组、CloudStream/EdgeStream 模块</a>
      <ul>
        <li><a href="#节点分组">节点分组</a>
          <ul>
            <li><a href="#功能说明">功能说明</a></li>
            <li><a href="#整体概览">整体概览</a></li>
            <li><a href="#代码路径">代码路径</a></li>
            <li><a href="#功能模块">功能模块</a></li>
          </ul>
        </li>
        <li><a href="#cloudstreamedgestream-模块解读">Cloudstream/Edgestream 模块解读</a>
          <ul>
            <li><a href="#功能说明-1">功能说明</a></li>
            <li><a href="#整体概览-1">整体概览</a></li>
            <li><a href="#代码路径-1">代码路径</a></li>
            <li><a href="#cloudstream流程">CloudStream流程</a></li>
            <li><a href="#edgestream-流程">EdgeStream 流程</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#节点与应用生命周期管理源码解析">节点与应用生命周期管理源码解析</a>
      <ul>
        <li><a href="#edgecontroller">EdgeController</a></li>
        <li><a href="#edgecontroller模块注册与启动">EdgeController模块注册与启动</a>
          <ul>
            <li><a href="#upstream-controller">Upstream Controller</a></li>
            <li><a href="#downstream-controller">Downstream Controller</a></li>
          </ul>
        </li>
        <li><a href="#metamanager">MetaManager</a></li>
        <li><a href="#edged">Edged</a>
          <ul>
            <li><a href="#edged的注册与启动">Edged的注册与启动</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="kubeedge-代码解析">kubeEdge 代码解析</h1>
<h2 id="目录">目录</h2>
<ul>
<li>
<p>CHANGELOG  版本新特性</p>
</li>
<li>
<p>其他组件依赖比较大的三个组件，beehive，viaduct, mapper-framework</p>
</li>
</ul>
<h2 id="beehive">beehive</h2>
<p>beehive是一个基于go channel的消息框架，用于KubeEdge模块之间的通信。</p>
<p>beehive模块在整个kubeedge中扮演了非常重要的作用，它实现了一套Module管理的接口，程序中各个模块的启动、运行、模块间的通信等都是由其统一封装管理。</p>
<p>Beehive 模块是 <a href="https://so.csdn.net/so/search?q=kubeedge&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreffer">kubeedge</a> 的核心模块，它负责管理所有模块的启动与停止，同时也负责多模块间的通信，它当前主要由: model, context, socket, channel 四个部分组成，其中：</p>
<h3 id="model-包">model 包</h3>
<ul>
<li>model 部分定义了消息的模型，这个消息模型是各个组件间通信所必须符合的规范。 这里面定义了结构体 message ，message是 beehive 不同 module 之间通信的信息载体，包含三部分内容：消息头、消息路由、消息内容。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Message struct
</span></span></span><span class="line"><span class="cl"><span class="c1">// model 包中定义了消息的模型， 其主要结构如下：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Message</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Header</span>  <span class="nx">MessageHeader</span> <span class="s">`json:&#34;header&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Router</span>  <span class="nx">MessageRoute</span>  <span class="s">`json:&#34;route,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Content</span> <span class="kd">interface</span><span class="p">{}</span>   <span class="s">`json:&#34;content&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// MessageRoute contains structure of message
</span></span></span><span class="line"><span class="cl"><span class="c1">// 消息路由：消息路由中定义了消息的一些操作和目的地等信息，其结构如下：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">MessageRoute</span> <span class="kd">struct</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">   <span class="c1">//消息的来源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">Source</span> <span class="kt">string</span> <span class="s">`json:&#34;source,omitempty&#34;`</span>  
</span></span><span class="line"><span class="cl">   <span class="c1">//消息的目的地
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">Destination</span> <span class="kt">string</span> <span class="s">`json:&#34;destination,omitempty&#34;`</span>  
</span></span><span class="line"><span class="cl">   <span class="c1">//消息广播的时候需要广播到哪个组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">Group</span> <span class="kt">string</span> <span class="s">`json:&#34;group,omitempty&#34;`</span>  
</span></span><span class="line"><span class="cl">   <span class="c1">//如何去操作资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">Operation</span> <span class="kt">string</span> <span class="s">`json:&#34;operation,omitempty&#34;`</span>  
</span></span><span class="line"><span class="cl">   <span class="c1">//想要操作的资源类型是什么
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">Resource</span> <span class="kt">string</span> <span class="s">`json:&#34;resource,omitempty&#34;`</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// MessageHeader defines message header details
</span></span></span><span class="line"><span class="cl"><span class="c1">// 消息头中主要定义了一些消息头部的详细信息，其结构如下：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">MessageHeader</span> <span class="kd">struct</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">   <span class="c1">//消息的ID,使用UUID生成。 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">ID</span> <span class="kt">string</span> <span class="s">`json:&#34;msg_id&#34;`</span>  
</span></span><span class="line"><span class="cl">   <span class="c1">//消息的父ID，一般在响应消息时候填充，其一般要与请求消息的ID相同
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">ParentID</span> <span class="kt">string</span> <span class="s">`json:&#34;parent_msg_id,omitempty&#34;`</span>  
</span></span><span class="line"><span class="cl">   <span class="c1">//消息的创建时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">Timestamp</span> <span class="kt">int64</span> <span class="s">`json:&#34;timestamp&#34;`</span>  
</span></span><span class="line"><span class="cl">   <span class="c1">//消息的特定资源版本，目前保存的是 k8s 资源的版本。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//kubeedge利用消息资源版本的概念来实现可靠传输。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">ResourceVersion</span> <span class="kt">string</span> <span class="s">`json:&#34;resourceversion,omitempty&#34;`</span>  
</span></span><span class="line"><span class="cl">   <span class="c1">//发送同步的标志位，该标志将在 sendsync 中设置。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">Sync</span> <span class="kt">bool</span> <span class="s">`json:&#34;sync,omitempty&#34;`</span>  
</span></span><span class="line"><span class="cl">   <span class="c1">//船渡消息的类型，一般为 channel，unixsocket 等类型，如果为空，则默认是 channel 类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">MessageType</span> <span class="kt">string</span> <span class="s">`json:&#34;type,omitempty&#34;`</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="context-包">context 包</h3>
<ul>
<li>
<p>context 部分定义了消息的上下文以及模块上下文两个接口，同时使用了一个全局上下文来管理各个类型的上下文。</p>
</li>
<li>
<p>model 管理 和 message消息通信管理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// ModuleContext is interface for context module management
</span></span></span><span class="line"><span class="cl"><span class="c1">// ModuleContext 接口定义了如何将 module 加入到当前 context, 并将其分组，以及，结束时如何清理模块的接口：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ModuleContext</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">AddModule</span><span class="p">(</span><span class="nx">info</span> <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">ModuleInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">AddModuleGroup</span><span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="nx">group</span> <span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Cleanup</span><span class="p">(</span><span class="nx">module</span> <span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// MessageContext is interface for message syncing
</span></span></span><span class="line"><span class="cl"><span class="c1">// MessageContext 接口定义了上下文如何为各个模块发送,接收,同步以及广播消息：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">MessageContext</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// async mode 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Send</span><span class="p">(</span><span class="nx">module</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">message</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span> <span class="c1">//发送同步消息到指定 module 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Receive</span><span class="p">(</span><span class="nx">module</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="c1">// 接受发送到指定 module的消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// sync mode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">SendSync</span><span class="p">(</span><span class="nx">module</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">message</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">,</span> <span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="c1">//发送同步消息到指定的 module
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">SendResp</span><span class="p">(</span><span class="nx">message</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span> <span class="c1">//发送对同步消息的响应
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// group broadcast
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">SendToGroup</span><span class="p">(</span><span class="nx">group</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">message</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span> <span class="c1">// 发送异步消息到指定的 group 下的所有module 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">SendToGroupSync</span><span class="p">(</span><span class="nx">group</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">message</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">,</span> <span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="kt">error</span> <span class="c1">// 发送同步消息到指定的 group 下的所有module 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>当前这个两个接口的实现，在 kubeedge 中，主要是由 socket 部分和 channel 部分对其进行了实现，分别用于远程模块通信与本地模块通信。</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 全局上下文 主要是给本地的上下文通信，
</span></span></span><span class="line"><span class="cl"><span class="c1">// 单例模式，启动就只存在一份。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// singleton
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">globalContext</span> <span class="o">*</span><span class="nx">GlobalContext</span>
</span></span><span class="line"><span class="cl">	<span class="nx">once</span>          <span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// GlobalContext 主要用来管理 module , message 与 Context 间的关系，以及提供一些方法，来便捷的操作 context, 其主要结构如下：
</span></span></span><span class="line"><span class="cl"><span class="c1">// GlobalContext is global context: only use for local cache to dispatch message
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">GlobalContext</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// 存储 context 类型与 ModuleContext 接口间关系
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// key 为 context 类型，value 为对应的 ModuleContext 接口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">moduleContext</span>  <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">ModuleContext</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// 存储 context 类型与 MessageContext 接口间关系  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// key 为 context 类型，value 为对应的 MessageContext 接口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">messageContext</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">MessageContext</span>  
</span></span><span class="line"><span class="cl">   <span class="c1">// 存储 module 与 context 类型间的关系
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// key 为 module 名称，value 为对应的 context 类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">moduleContextType</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>  
</span></span><span class="line"><span class="cl">   <span class="c1">// 存储 group 与 context 类型间的关系
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// key 为 group 名称，value 为对应的 context 类型 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">groupContextType</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">   <span class="nx">ctx</span>     <span class="nx">gocontext</span><span class="p">.</span><span class="nx">Context</span>  
</span></span><span class="line"><span class="cl">   <span class="nx">cancel</span>  <span class="nx">gocontext</span><span class="p">.</span><span class="nx">CancelFunc</span>  
</span></span><span class="line"><span class="cl">   <span class="nx">ctxLock</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 根据传入的 contextTypes 初始化 context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">InitContext</span><span class="p">(</span><span class="nx">contextTypes</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 获取 context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">GetContext</span><span class="p">()</span> <span class="nx">gocontext</span><span class="p">.</span><span class="nx">Context</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 结束
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">Done</span><span class="p">()</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 取消
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">Cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 添加 module
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">AddModule</span><span class="p">(</span><span class="nx">module</span> <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">ModuleInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 添加 module group
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">AddModuleGroup</span><span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="nx">group</span> <span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 清理 module
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">Cleanup</span><span class="p">(</span><span class="nx">module</span> <span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 发送消息到模块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">Send</span><span class="p">(</span><span class="nx">module</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">message</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 接收模块的消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">Receive</span><span class="p">(</span><span class="nx">module</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 发送同步消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">SendSync</span><span class="p">(</span><span class="nx">module</span> <span class="kt">string</span><span class="p">,</span><span class="nx">message</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">,</span> <span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)(</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 发送响应消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">SendResp</span><span class="p">(</span><span class="nx">resp</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 发送广播消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">SendToGroup</span><span class="p">(</span><span class="nx">group</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">message</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 发送同步广播消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">SendToGroupSync</span><span class="p">(</span><span class="nx">group</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">message</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">,</span> <span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="kt">error</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="channel-包">channel 包</h3>
<ul>
<li>
<p>channel 部分则实现了channel 类型的上下文通信，主要用于本地通信。即程序内部不同模块间的交互。其结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Context</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// 存储 module 与 channel 的关系
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// key 为模块名称， value 为 对应的 channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// 默认channel 缓冲区大小为1024
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">channels</span>     <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>  
</span></span><span class="line"><span class="cl">   <span class="nx">chsLock</span>      <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// 存储 group , module 与 channel 的关系
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// 第一层 key 为 group
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// 第二层 key 为 module ,vaule 为 channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">typeChannels</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>  
</span></span><span class="line"><span class="cl">   <span class="nx">typeChsLock</span>  <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span> 
</span></span><span class="line"><span class="cl">   <span class="c1">// 匿名通道map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// 存储 message 与 channel 的关系
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// key 为 messageID ，value 为 channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">anonChannels</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>  
</span></span><span class="line"><span class="cl">   <span class="nx">anonChsLock</span>  <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>定义了很多方法，方便通信。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240202102645945.png"
        data-srcset="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240202102645945.png, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240202102645945.png 1.5x, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240202102645945.png 2x"
        data-sizes="auto"
        alt="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240202102645945.png"
        title="image-20240202102645945" /></p>
</li>
</ul>
<h3 id="socket-包">socket 包</h3>
<ul>
<li>socket 部分则实现了socket 类型的上下文通信，主要用于非本地通信。</li>
</ul>
<p>socket 部分主要用于远程信息交换，底层通过 net.conn 获取连接。它主要有以下几个部分组成：</p>
<ul>
<li>broker: 网络代理</li>
<li>config: 配置</li>
<li>socket: socket module</li>
<li>stroe: 通信存储</li>
<li>keeper: 心跳保持</li>
<li>wapper: 消息打包</li>
</ul>
<h4 id="context_socketgo">context_socket.go</h4>
<h3 id="corego">Core.go</h3>
<p>启动所有的module</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// Run starts the modules and in the end does module cleanup
</span></span><span class="line"><span class="cl">func Run() {
</span></span><span class="line"><span class="cl">	// Address the module registration and start the core
</span></span><span class="line"><span class="cl">	StartModules()
</span></span><span class="line"><span class="cl">	// monitor system signal and shutdown gracefully
</span></span><span class="line"><span class="cl">	GracefulShutdown()
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="modulego">Module.go</h3>
<p>实现下面 4个方法，可以继承 module</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Module interface
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Module</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Name</span><span class="p">()</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Group</span><span class="p">()</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Enable</span><span class="p">()</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>message 信件</p>
<p>module 邮件箱</p>
<p>channel   socket 两种交流方式，一种放完就走，一种在等待你的回复。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/234e1e9539d64a8b8775505572cc2ef7.png"
        data-srcset="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/234e1e9539d64a8b8775505572cc2ef7.png, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/234e1e9539d64a8b8775505572cc2ef7.png 1.5x, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/234e1e9539d64a8b8775505572cc2ef7.png 2x"
        data-sizes="auto"
        alt="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/234e1e9539d64a8b8775505572cc2ef7.png"
        title="beehive" /></p>
<p>参考：</p>
<p><a href="https://blog.csdn.net/All_Dream_and_you/article/details/128317305?spm=1001.2014.3001.5502" target="_blank" rel="noopener noreffer">https://blog.csdn.net/All_Dream_and_you/article/details/128317305?spm=1001.2014.3001.5502</a></p>
<h2 id="cloudcore">CloudCore</h2>
<p>当 cloudcore 启动时，会将所有的module都注册到 beehive</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240130135725189.png"
        data-srcset="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240130135725189.png, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240130135725189.png 1.5x, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240130135725189.png 2x"
        data-sizes="auto"
        alt="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240130135725189.png"
        title="image-20240130135725189" /></p>
<h3 id="cloudhub">CloudHub</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/main.jpg"
        data-srcset="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/main.jpg, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/main.jpg 1.5x, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/main.jpg 2x"
        data-sizes="auto"
        alt="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/main.jpg"
        title="main" /></p>
<p>CloudHub是云端组件 CloudCore 的一个模块，负责边缘节点的接入和云边数据传输，是Controller 和边缘 EdgeCore 之间的中介。它负责分发下行消息（其内封装了 k8s 资源事件，如pod update等）到边缘节点，也负责接收边缘节点发送到状态消息并转发至对应的 controllers。CloudHub 在 KubeEdge 中的位置如下所示：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218095646999.png"
        data-srcset="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218095646999.png, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218095646999.png 1.5x, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218095646999.png 2x"
        data-sizes="auto"
        alt="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218095646999.png"
        title="image-20240218095646999" /></p>
<p>Cloudhub 内部有几个重要的代码模块，如下所示：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218095829756.png"
        data-srcset="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218095829756.png, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218095829756.png 1.5x, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218095829756.png 2x"
        data-sizes="auto"
        alt="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218095829756.png"
        title="image-20240218095829756" /></p>
<ul>
<li>HTTP server ： 为边缘节点提供证书服务入口，如获取CA证书、证书签发与证书轮转</li>
<li>WebSocket server: 可配置是否开启，为边缘节点提供 Websocket 协议接入服务</li>
<li>QUIC server： 可配置是否开启，为边缘节点提供 QUIC 协议接入服务</li>
<li>CSI socket server：在云端用来和 csi driver 通信</li>
<li>Token manager： 边缘节点接入 token 凭据管理，token 默认12h 轮转</li>
<li>Certificate manager :边缘节点证书签发和轮转的实现模块</li>
<li>massage  handler：边缘节点接入管理和边缘消息处理分发</li>
<li>Node session manager： 边缘节点会话生命周期管理</li>
<li>message dispatcher ：上行和下行消息分发管理</li>
</ul>
<h4 id="cloudhub-启动流程">CloudHub 启动流程</h4>
<p>Cloudhub在cloud core启动时注册，通过beehive消息通信框架调用 start() 函数启动 cloudhub 模块。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">cloudhub</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Modules</span><span class="p">.</span><span class="nx">CloudHub</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>CloudHub 启动的时候，首先会启动 dispatcher.DispatchDownstream 协程。用来异步分发下行消息。</p>
<p>其次进行证书的初始化，如果没有配置证书，则会自动生成CA和 服务证书，用于后续 websocket QUIC HTTP 服务的安全通讯。</p>
<p>然后启动 token manager 模块，生成边缘节点接入使用的token凭据以及开启自动轮转服务。startHTTPServer()启动服务监听，主要用于 EdgeCore 申请证书。它将等待 edgecore  发来请求，获取证书。</p>
<p>然后，启动Cloudhub 服务，具体的操作是使用 viaduct 中间件启动一个服务器，等待 Edgeore 发来连接请求，协议可以是基于 tcp 的WebSocket 或基于 udp 的 QUIC。如果用户需要使用 CSI 相关功能，则会启动 CSI socket server。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">ch</span> <span class="o">*</span><span class="nx">cloudHub</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 等待同步完成
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">cache</span><span class="p">.</span><span class="nf">WaitForCacheSync</span><span class="p">(</span><span class="nx">beehiveContext</span><span class="p">.</span><span class="nf">Done</span><span class="p">(),</span> <span class="nx">ch</span><span class="p">.</span><span class="nx">informersSyncedFuncs</span><span class="o">...</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unable to sync caches for objectSyncController&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// start dispatch message from the cloud to edge node 分发消息到边端
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="nx">ch</span><span class="p">.</span><span class="nx">dispatcher</span><span class="p">.</span><span class="nf">DispatchDownstream</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// check whether the certificates exist in the local directory,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// and then check whether certificates exist in the secret, generate if they don&#39;t exist
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">httpserver</span><span class="p">.</span><span class="nf">PrepareAllCerts</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// TODO: Will improve in the future
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">DoneTLSTunnelCerts</span> <span class="o">&lt;-</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="nb">close</span><span class="p">(</span><span class="nx">DoneTLSTunnelCerts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// generate Token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">httpserver</span><span class="p">.</span><span class="nf">GenerateToken</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// HttpServer mainly used to issue certificates for the edge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="nx">httpserver</span><span class="p">.</span><span class="nf">StartHTTPServer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">servers</span><span class="p">.</span><span class="nf">StartCloudHub</span><span class="p">(</span><span class="nx">ch</span><span class="p">.</span><span class="nx">messageHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">hubconfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">UnixSocket</span><span class="p">.</span><span class="nx">Enable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// The uds server is only used to communicate with csi driver from kubeedge on cloud.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// It is not used to communicate between cloud and edge.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">go</span> <span class="nx">udsserver</span><span class="p">.</span><span class="nf">StartServer</span><span class="p">(</span><span class="nx">hubconfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">UnixSocket</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来，我看一下cloudhub 的核心功能，边缘节点接入管理和消息分发管理。下图是 CloudHub 的内部实现架构图：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218134132879.png"
        data-srcset="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218134132879.png, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218134132879.png 1.5x, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218134132879.png 2x"
        data-sizes="auto"
        alt="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218134132879.png"
        title="image-20240218134132879" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218134144796.png"
        data-srcset="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218134144796.png, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218134144796.png 1.5x, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218134144796.png 2x"
        data-sizes="auto"
        alt="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218134144796.png"
        title="image-20240218134144796" /></p>
<h4 id="下行消息发送模式">下行消息发送模式</h4>
<p>发送到边缘节点的下行消息，有两种发送模式，这两种发送模式，直接关系到下行消息的分发和节点session的消息处理，如下所示：</p>
<p>ACK模式：在这种模式下，边缘节点收到下行消息并将消息正确保存到本地数据存储之后，需要给云端发送ACK响应消息以通知消息在边缘测被正确处理，如果云端没有收到ACK消息，则认为消息没有在边缘节点正确处理，则会重试，直到收到ACK响应消息。</p>
<p>NO-ACK 模式：在这种模式下，边缘节点收到下行消息后，不需要给云端发送ACK响应消息，云端认为边缘测已经收到消息并正确处理，在这种模式下，消息有可能会丢失。这种模式，通常用于给边缘节点同步消息发送响应，如果边缘测没有收到响应，则会出发重试操作。</p>
<h4 id="边缘节点接入">边缘节点接入</h4>
<p>边缘节点接入的主要逻辑在messageHandler里面，handler借口如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Handler</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// HandleConnection is invoked when a new connection arrives
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">HandleConnection</span><span class="p">(</span><span class="nx">connection</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Connection</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// HandleMessage is invoked when a new message arrives.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">HandleMessage</span><span class="p">(</span><span class="nx">container</span> <span class="o">*</span><span class="nx">mux</span><span class="p">.</span><span class="nx">MessageContainer</span><span class="p">,</span> <span class="nx">writer</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// OnEdgeNodeConnect is invoked when a new connection is established
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">OnEdgeNodeConnect</span><span class="p">(</span><span class="nx">info</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">HubInfo</span><span class="p">,</span> <span class="nx">connection</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Connection</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// OnEdgeNodeDisconnect is invoked when a connection is lost
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">OnEdgeNodeDisconnect</span><span class="p">(</span><span class="nx">info</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">HubInfo</span><span class="p">,</span> <span class="nx">connection</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Connection</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// OnReadTransportErr is invoked when the connection read message err
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">OnReadTransportErr</span><span class="p">(</span><span class="nx">nodeID</span><span class="p">,</span> <span class="nx">projectID</span> <span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>HandleConnection 用来处理边缘节点接入，以WebSocket协议接入为例，WebSocket server 通过 viaduct 启动之后，当有边缘节点接上来时，viaduct 中 serverHTTP 将 http 协议 upgrade 成为 web socket 协议，然后初始化 Connection 对象，HandleConnection 根据传入的 connection 对象进行一系列初始化操作：</p>
<ol>
<li>
<p>执行初始化签前的校验工作，如是否超过配置的 node 数量限制。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">	<span class="nx">nodeID</span> <span class="o">:=</span> <span class="nx">connection</span><span class="p">.</span><span class="nf">ConnectionState</span><span class="p">().</span><span class="nx">Headers</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;node_id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">projectID</span> <span class="o">:=</span> <span class="nx">connection</span><span class="p">.</span><span class="nf">ConnectionState</span><span class="p">().</span><span class="nx">Headers</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;project_id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">mh</span><span class="p">.</span><span class="nx">SessionManager</span><span class="p">.</span><span class="nf">ReachLimit</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Fail to serve node %s, reach node limit&#34;</span><span class="p">,</span> <span class="nx">nodeID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>初始化 nodeMessagePool ,并加入到 MessageDispatcher 的哈希表中，用于存储分发的下行消息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">		<span class="c1">// init node message pool and add to the dispatcher
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">nodeMessagePool</span> <span class="o">:=</span> <span class="nx">common</span><span class="p">.</span><span class="nf">InitNodeMessagePool</span><span class="p">(</span><span class="nx">nodeID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">mh</span><span class="p">.</span><span class="nx">MessageDispatcher</span><span class="p">.</span><span class="nf">AddNodeMessagePool</span><span class="p">(</span><span class="nx">nodeID</span><span class="p">,</span> <span class="nx">nodeMessagePool</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>nodeMessagePool 是用来存储下行消息的队列，每个边缘节点的接入时，都会初始化一个对应的 nodeMessagePool，和之前的下行消息发送模式对应， nodeMessagePool 包含两个队列，分别用来存储ACK和NO-ACK模式的下行消息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="c1">// NodeMessagePool is a collection of all downstream messages sent to an
</span></span></span><span class="line"><span class="cl"><span class="c1">// edge node. There are two types of messages, one that requires an ack
</span></span></span><span class="line"><span class="cl"><span class="c1">// and one that does not. For each type of message, we use the `queue` to
</span></span></span><span class="line"><span class="cl"><span class="c1">// mark the order of sending, and use the `store` to store specific messages
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">NodeMessagePool</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// AckMessageStore store message that will send to edge node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// and require acknowledgement from edge node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">AckMessageStore</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">Store</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// AckMessageQueue store message key that will send to edge node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// and require acknowledgement from edge node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">AckMessageQueue</span> <span class="nx">workqueue</span><span class="p">.</span><span class="nx">RateLimitingInterface</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// NoAckMessageStore store message that will send to edge node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// and do not require acknowledgement from edge node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">NoAckMessageStore</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">Store</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// NoAckMessageQueue store message key that will send to edge node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// and do not require acknowledgement from edge node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">NoAckMessageQueue</span> <span class="nx">workqueue</span><span class="p">.</span><span class="nx">RateLimitingInterface</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>初始化nodeSession 对象，加入到 SessionManager 哈希表中，并启动nodeSession</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">		<span class="c1">// create a node session for each edge node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">nodeSession</span> <span class="o">:=</span> <span class="nx">session</span><span class="p">.</span><span class="nf">NewNodeSession</span><span class="p">(</span><span class="nx">nodeID</span><span class="p">,</span> <span class="nx">projectID</span><span class="p">,</span> <span class="nx">connection</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">keepaliveInterval</span><span class="p">,</span> <span class="nx">nodeMessagePool</span><span class="p">,</span> <span class="nx">mh</span><span class="p">.</span><span class="nx">reliableClient</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// add node session to the session manager
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">mh</span><span class="p">.</span><span class="nx">SessionManager</span><span class="p">.</span><span class="nf">AddSession</span><span class="p">(</span><span class="nx">nodeSession</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// start session for each edge node and it will keep running until
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// it encounters some Transport Error from underlying connection.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">nodeSession</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>每个边缘节点对应一个nodeSession,nodeSession是对每个边缘节点连接会话的抽象，SessionManager 存储并管理连接到当前 cloudHub 的所有边缘节点的session，nodeSession启东时，会启动该节点所需要的所有处理协程。包括： KeepAliveCheck 心跳检测，SendAcKMessage 发送ACK模式的下行消息，SendNoAcKMessage 发送NO-ACK模式的下行消息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Start the main goroutine responsible for serving node session
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ns</span> <span class="o">*</span><span class="nx">NodeSession</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Start session for edge node %s&#34;</span><span class="p">,</span> <span class="nx">ns</span><span class="p">.</span><span class="nx">nodeID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">ns</span><span class="p">.</span><span class="nf">KeepAliveCheck</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">ns</span><span class="p">.</span><span class="nf">SendAckMessage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">ns</span><span class="p">.</span><span class="nf">SendNoAckMessage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">&lt;-</span><span class="nx">ns</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h4 id="上下行消息分发">上下行消息分发</h4>
<p>在 CloudHub 中，上行消息的处理比较简单，主要逻辑在 Message Handler的handleMessage方法中，底层的 viaduct库进行数据的解析转换成MessageContainer对象，里面包含了message 信息，handleMessage 收到message后，进行简单的校验，然后调用 Message Dispatcher DispatcherUpstream 方法，转发到不同的模块，如 edgeController deviceController等。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="c1">// HandleMessage handle all the request from node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">mh</span> <span class="o">*</span><span class="nx">messageHandler</span><span class="p">)</span> <span class="nf">HandleMessage</span><span class="p">(</span><span class="nx">container</span> <span class="o">*</span><span class="nx">mux</span><span class="p">.</span><span class="nx">MessageContainer</span><span class="p">,</span> <span class="nx">writer</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nodeID</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;node_id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">projectID</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;project_id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// validate message
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">container</span><span class="p">.</span><span class="nx">Message</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;The message is nil for node: %s&#34;</span><span class="p">,</span> <span class="nx">nodeID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;[messageHandler]get msg from node(%s): %+v&#34;</span><span class="p">,</span> <span class="nx">nodeID</span><span class="p">,</span> <span class="nx">container</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// dispatch upstream message
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">mh</span><span class="p">.</span><span class="nx">MessageDispatcher</span><span class="p">.</span><span class="nf">DispatchUpstream</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">Message</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">model</span><span class="p">.</span><span class="nx">HubInfo</span><span class="p">{</span><span class="nx">ProjectID</span><span class="p">:</span> <span class="nx">projectID</span><span class="p">,</span> <span class="nx">NodeID</span><span class="p">:</span> <span class="nx">nodeID</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>下行消息的分发流程如上图D1-D5所示，以发送ACK消息为例，主要包括以下流程：</p>
<ol>
<li>KubeEdge使用 k8s objectSync CRD 存储已成功发送到Edge的资源的最新resourceVersion ，当CloudHub重新启动或正常启动时。它将检查待发送的资源 resourceVersion 和 已发送成功的 resourceVersion，以避免发送旧消息。</li>
<li>EdgeController 和 device controller 等将消息发送到 Cloudhub ，MessageDispatcher 将根据消息中的节点名称，将消息发送到相应的 NodeMessagePool ，同时会根据消息的resource等信息来选择发送模式。在加入队列的过程中，会查询资源对应的objectSync CR ,获取发送成功的最新资源resourceVersion ，并和待加入队列的消息比较，避免重复发送。</li>
<li>节点对应的 nodeSession SendAckMessage 协程江顺序地江数据从NodeMessagePool 取出发送到相应的边缘节点。同时并将消息ID存储在 ACK channel 中，当收到来自边缘节点的ACK消息时，ACK channel 将收到通知，并将当前消息的 resourceVersion 保存到 objectSync CR 中，并发送下一条消息。</li>
<li>当Edgecore 收到消息时，它首先将消息保存到本地数据存储中，然后将ACK消息返回云端。如果cloudhub 在此间隔内未收到ACK 消息，它将继续重发该消息5次，如果所有5次重试均失败，cloudhub 将丢弃该事件。</li>
<li>CloudCore 中另一个模块 SyncController 将处理这些失败的事件，即使边缘节点接收到消息，返回到ACK消息也可能在传输过程中丢失，在这种情况下，SyncController 将再次发送消息给 cloudhub ，再次触发下行消息分发，直至成功。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">ns</span> <span class="o">*</span><span class="nx">NodeSession</span><span class="p">)</span> <span class="nf">sendMessageWithRetry</span><span class="p">(</span><span class="nx">copyMsg</span><span class="p">,</span> <span class="nx">msg</span> <span class="o">*</span><span class="nx">beehivemodel</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ackChan</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ns</span><span class="p">.</span><span class="nx">ackMessageCache</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="nx">copyMsg</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="nx">ackChan</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// initialize retry count and timer for sending message
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">retryCount</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ticker</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTimer</span><span class="p">(</span><span class="nx">sendRetryInterval</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">ns</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nf">WriteMessageAsync</span><span class="p">(</span><span class="nx">copyMsg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ackChan</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ns</span><span class="p">.</span><span class="nf">saveSuccessPoint</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ticker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">retryCount</span> <span class="o">==</span> <span class="mi">4</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">ErrWaitTimeout</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">ns</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nf">WriteMessageAsync</span><span class="p">(</span><span class="nx">copyMsg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">retryCount</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ticker</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="nx">sendRetryInterval</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="synccontroller">SyncController</h3>
<p>在边缘计算场景下，边缘的网络通常是不稳定的，这将导致云边的网络连接频繁断开，在云边协同通信时存在丢失数据的风险。sync controller 是 cloudCore 中的一个模块，用来保障消息的可靠性发送，在KubeEdge中，使用objectSync 对象来持久化云边协同消息状态。在云和边缘状态同步的过程中，云端会实时记录每个边缘节点同步成功的最新消息版本号（ResourceVersion）并以CR的形式持久化保存到k8s中，该机制可以保证在边缘场景下云端故障或者边缘离线重启后消息发送的顺序和连续性，避免重发旧消息引起云边状态不一致问题。与此同时，synccontroller 会周期性检查同步云边数据，保持一致性。它主要负责周期性检查各个边缘节点的同步状态，对比 k8s 中资源的信息，将不一致的状态同步到边缘，确保云边状态的最终一致性。</p>
<p>synccontroller 在 cloudCore 启动时注册，通过 beehive 消息通信框架调用 start（）函数启动 synccontroller 模块。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">synccontroller.Register(c.Modules.SyncController)
</span></span></code></pre></td></tr></table>
</div>
</div><p>synccontroller 启动时，会开启周期性的检测，间隔5s执行一次</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="c1">// Start controller
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">sctl</span> <span class="o">*</span><span class="nx">SyncController</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">cache</span><span class="p">.</span><span class="nf">WaitForCacheSync</span><span class="p">(</span><span class="nx">beehiveContext</span><span class="p">.</span><span class="nf">Done</span><span class="p">(),</span> <span class="nx">sctl</span><span class="p">.</span><span class="nx">informersSyncedFuncs</span><span class="o">...</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unable to sync caches for sync controller&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">sctl</span><span class="p">.</span><span class="nf">deleteObjectSyncs</span><span class="p">()</span> <span class="c1">//check outdate sync before start to reconcile
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">sctl</span><span class="p">.</span><span class="nf">deleteClusterObjectSyncs</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">wait</span><span class="p">.</span><span class="nf">Until</span><span class="p">(</span><span class="nx">sctl</span><span class="p">.</span><span class="nx">reconcileObjectSyncs</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span> <span class="nx">beehiveContext</span><span class="p">.</span><span class="nf">Done</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">wait</span><span class="p">.</span><span class="nf">Until</span><span class="p">(</span><span class="nx">sctl</span><span class="p">.</span><span class="nx">reconcileClusterObjectSyncs</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span> <span class="nx">beehiveContext</span><span class="p">.</span><span class="nf">Done</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ObjectSync用于保存命名空间的对象，它们的名称由相关节点名称和对象UUID组成。SyncController 将定期比较保存的 ObjectSync 对象中的已发送resourceVersion 和 k8s 中的对象，然后触发诸如重试和删除之类的事件。当 cloudhub 将事件添加到 NodeMessagePool 中的相应对象进行比较。如果 NodeMessagePool 中的对象比较新，它将直接丢弃这些事件，否则CloudHub 将消息发送到边缘侧。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218171300451.png"
        data-srcset="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218171300451.png, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218171300451.png 1.5x, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218171300451.png 2x"
        data-sizes="auto"
        alt="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240218171300451.png"
        title="image-20240218171300451" /></p>
<h2 id="edgehub">EdgeHub</h2>
<p>EdgeHub 是一个Web Socket 或者 QUIC 协议的客户端，负责与云端的CloudCore 交互，包括同步云端资源更新，报告边缘主机和设备状态变化到云端等功能。</p>
<p>EdgeHub 在 Edgeore 启动时通过 beehive 框架注册，并对 edgehub 进行了初始化</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Register register edgehub
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Register</span><span class="p">(</span><span class="nx">eh</span> <span class="o">*</span><span class="nx">v1alpha2</span><span class="p">.</span><span class="nx">EdgeHub</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">config</span><span class="p">.</span><span class="nf">InitConfigure</span><span class="p">(</span><span class="nx">eh</span><span class="p">,</span> <span class="nx">nodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">core</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nf">newEdgeHub</span><span class="p">(</span><span class="nx">eh</span><span class="p">.</span><span class="nx">Enable</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>EdgeHub 启动代码如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Start sets context and starts the controller
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">eh</span> <span class="o">*</span><span class="nx">EdgeHub</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">eh</span><span class="p">.</span><span class="nx">certManager</span> <span class="p">=</span> <span class="nx">certificate</span><span class="p">.</span><span class="nf">NewCertManager</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">EdgeHub</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">eh</span><span class="p">.</span><span class="nx">certManager</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nf">GetCertSyncChannel</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">v</span> <span class="o">&lt;-</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="nb">close</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">eh</span><span class="p">.</span><span class="nf">ifRotationDone</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">beehiveContext</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">&#34;EdgeHub stop&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">eh</span><span class="p">.</span><span class="nf">initial</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Exitf</span><span class="p">(</span><span class="s">&#34;failed to init controller: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">waitTime</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Heartbeat</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">eh</span><span class="p">.</span><span class="nx">chClient</span><span class="p">.</span><span class="nf">Init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;connection failed: %v, will reconnect after %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">waitTime</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">waitTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// execute hook func after connect
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">eh</span><span class="p">.</span><span class="nf">pubConnectInfo</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">eh</span><span class="p">.</span><span class="nf">routeToEdge</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">eh</span><span class="p">.</span><span class="nf">routeToCloud</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">eh</span><span class="p">.</span><span class="nf">keepalive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// wait the stop signal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// stop authinfo manager/websocket connection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="o">&lt;-</span><span class="nx">eh</span><span class="p">.</span><span class="nx">reconnectChan</span>
</span></span><span class="line"><span class="cl">		<span class="nx">eh</span><span class="p">.</span><span class="nx">chClient</span><span class="p">.</span><span class="nf">UnInit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// execute hook fun after disconnect
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">eh</span><span class="p">.</span><span class="nf">pubConnectInfo</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// sleep one period of heartbeat, then try to connect cloud hub again
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;connection is broken, will reconnect after %s&#34;</span><span class="p">,</span> <span class="nx">waitTime</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">waitTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// clean channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">clean</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">eh</span><span class="p">.</span><span class="nx">reconnectChan</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span> <span class="nx">clean</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>EdgeHub 的启动过程如下所示，主要包含以下步骤：</p>
<ol>
<li>证书初始化，从 Cloudcore 申请证书（若正确配置本地证书，则直接使用本地证书），启动证书轮转模块，然后进入循环</li>
<li>调用 eh.initial() 创建 eh.chClient，接着调用 eh.chClient.init()，初始化过程通过viaduct 库建立了websoket/quic 的connection</li>
<li>调用 eh.pubConnetinfo(true),向 edge core 各模块广播已经连接成功的消息</li>
<li>接下来启动了三个协程：
<ul>
<li>routeToEdge</li>
<li>routeToCloud</li>
<li>keepalive</li>
</ul>
</li>
</ol>
<p><strong>routeToEdge</strong>：接收云端发送下来的消息，如果是同步消息响应，则调用beehive sendResp 发送响应，否则，根据消息的group，发送到对应的group</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">eh</span> <span class="o">*</span><span class="nx">EdgeHub</span><span class="p">)</span> <span class="nf">routeToEdge</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">beehiveContext</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">&#34;EdgeHub RouteToEdge stop&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">message</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">eh</span><span class="p">.</span><span class="nx">chClient</span><span class="p">.</span><span class="nf">Receive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;websocket read error: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">eh</span><span class="p">.</span><span class="nx">reconnectChan</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;[edgehub/routeToEdge] receive msg from cloud, msg:% +v&#34;</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">eh</span><span class="p">.</span><span class="nf">dispatch</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to dispatch message, discard: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>routeToCloud</strong> 接收边缘侧其他module 发送过来的消息，然后将消息通过 web socket/quic client 发送到云端</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">eh</span> <span class="o">*</span><span class="nx">EdgeHub</span><span class="p">)</span> <span class="nf">routeToCloud</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">beehiveContext</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">&#34;EdgeHub RouteToCloud stop&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">message</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">beehiveContext</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="nx">modules</span><span class="p">.</span><span class="nx">EdgeHubModuleName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to receive message from edge: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">eh</span><span class="p">.</span><span class="nf">tryThrottle</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nf">GetID</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;msgID: %s, client rate limiter returned an error: %v &#34;</span><span class="p">,</span> <span class="nx">message</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// post message to cloud hub
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">err</span> <span class="p">=</span> <span class="nx">eh</span><span class="p">.</span><span class="nf">sendToCloud</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to send message to cloud: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">eh</span><span class="p">.</span><span class="nx">reconnectChan</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Keepalive</strong>:根据心跳周期定期向云端发送心跳信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">eh</span> <span class="o">*</span><span class="nx">EdgeHub</span><span class="p">)</span> <span class="nf">keepalive</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">beehiveContext</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">&#34;EdgeHub KeepAlive stop&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">msg</span> <span class="o">:=</span> <span class="nx">model</span><span class="p">.</span><span class="nf">NewMessage</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">			<span class="nf">BuildRouter</span><span class="p">(</span><span class="nx">modules</span><span class="p">.</span><span class="nx">EdgeHubModuleName</span><span class="p">,</span> <span class="s">&#34;resource&#34;</span><span class="p">,</span> <span class="s">&#34;node&#34;</span><span class="p">,</span> <span class="nx">messagepkg</span><span class="p">.</span><span class="nx">OperationKeepalive</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">			<span class="nf">FillBody</span><span class="p">(</span><span class="s">&#34;ping&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// post message to cloud hub
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">eh</span><span class="p">.</span><span class="nf">sendToCloud</span><span class="p">(</span><span class="o">*</span><span class="nx">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;websocket write error: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">eh</span><span class="p">.</span><span class="nx">reconnectChan</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Heartbeat</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>当云边消息传送过程中出现错误时，边缘部分会重新 init 相应的 websocket/quic client ，与云端重新建立连接。</li>
</ol>
<h2 id="节点分组cloudstreamedgestream-模块">节点分组、CloudStream/EdgeStream 模块</h2>
<h3 id="节点分组">节点分组</h3>
<h4 id="功能说明">功能说明</h4>
<p>Kubeedge 1.11版本提供了”边缘节点分组管理“新特性，抽象出了跨地域的应用部署模型。该模型将边缘节点按地区划分为节点组。将服务流量限制在同一节点组中，并将应用所需资源打包成一个整体在节点组上进行部署，降低了边缘应用生命周期管理的复杂度、有效减少运维成本。</p>
<p>该特性由PR#3719实现</p>
<h4 id="整体概览">整体概览</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240219160600413.png"
        data-srcset="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240219160600413.png, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240219160600413.png 1.5x, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240219160600413.png 2x"
        data-sizes="auto"
        alt="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240219160600413.png"
        title="image-20240219160600413" /></p>
<h4 id="代码路径">代码路径</h4>
<ul>
<li>NodeGroup：cloud/pkg/controllermanager/nodegroup</li>
<li>EdgeApplication：cloud/pkg/controllermanager/edgeapplication</li>
<li>Filter：cloud/pkg/dynamiccontroller/filter/</li>
</ul>
<h4 id="功能模块">功能模块</h4>
<p>NodeGroup：k8s自定义CRD，节点分组可以通过matchLabels字段，指定节点名会长节点的Label两种方式对节点进行选择，被选中的节点会被添加上apps.kubeedge.io/belonging-to:nodegroup的Label。</p>
<p>首先，看下NodeGroup的资源定义。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="c1">// NodeGroup is the Schema for the nodegroups API
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">NodeGroup</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span>   <span class="s">`json:&#34;,inline&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span> <span class="s">`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Spec represents the specification of the desired behavior of member nodegroup.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +required
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Spec</span> <span class="nx">NodeGroupSpec</span> <span class="s">`json:&#34;spec,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Status represents the status of member nodegroup.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Status</span> <span class="nx">NodeGroupStatus</span> <span class="s">`json:&#34;status,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// NodeGroupSpec defines the desired state of NodeGroup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">NodeGroupSpec</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Nodes contains names of all the nodes in the nodegroup.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Nodes</span> <span class="p">[]</span><span class="kt">string</span> <span class="s">`json:&#34;nodes,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// MatchLabels are used to select nodes that have these labels.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">MatchLabels</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span> <span class="s">`json:&#34;matchLabels,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// NodeGroupStatus contains the observed status of all selected nodes in
</span></span></span><span class="line"><span class="cl"><span class="c1">// this NodeGroup, including nodes that have been one of the members of this NodeGroup
</span></span></span><span class="line"><span class="cl"><span class="c1">// and those have not.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">NodeGroupStatus</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// NodeStatuses is a status list of all selected nodes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">NodeStatuses</span> <span class="p">[]</span><span class="nx">NodeStatus</span> <span class="s">`json:&#34;nodeStatuses,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>代码处理流程如下：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240219165302464.png"
        data-srcset="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240219165302464.png, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240219165302464.png 1.5x, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240219165302464.png 2x"
        data-sizes="auto"
        alt="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240219165302464.png"
        title="image-20240219165302464" /></p>
<p>可以看到，NodeGroup 的处理主体流程时基于 sigs.k8s.io/controlle-runtime模块实现，通过注册nodeGroupController并启动 Reconcile 进行资源轮询，确保资源状态同步。</p>
<p>EdgeApplication: K8s 自定义CRD，边缘应用用于应用资源打包，按照节点组进行部署，并满足不同节点组之间的差异化部署要求。</p>
<p>资源定义如下。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="c1">// EdgeApplication is the Schema for the edgeapplications API
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">EdgeApplication</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span>   <span class="s">`json:&#34;,inline&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span> <span class="s">`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Spec represents the desired behavior of EdgeApplication.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +required
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Spec</span> <span class="nx">EdgeApplicationSpec</span> <span class="s">`json:&#34;spec,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Status represents the status of PropagationStatus.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Status</span> <span class="nx">EdgeApplicationStatus</span> <span class="s">`json:&#34;status,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// EdgeApplicationSpec defines the desired state of EdgeApplication
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">EdgeApplicationSpec</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// WorkloadTemplate contains original templates of resources to be deployed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// as an EdgeApplication.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">WorkloadTemplate</span> <span class="nx">ResourceTemplate</span> <span class="s">`json:&#34;workloadTemplate,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// WorkloadScope represents which node groups the workload will be deployed in.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">WorkloadScope</span> <span class="nx">WorkloadScope</span> <span class="s">`json:&#34;workloadScope&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// WorkloadScope represents which node groups the workload should be deployed in.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">WorkloadScope</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// TargetNodeGroups represents the target node groups of workload to be deployed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">TargetNodeGroups</span> <span class="p">[]</span><span class="nx">TargetNodeGroup</span> <span class="s">`json:&#34;targetNodeGroups,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>代码处理流程图如下：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240219171410774.png"
        data-srcset="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240219171410774.png, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240219171410774.png 1.5x, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240219171410774.png 2x"
        data-sizes="auto"
        alt="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240219171410774.png"
        title="image-20240219171410774" /></p>
<p>EdgeApplication资源同步流程和NodeGroup类似，主体框架都是基于 于 sigs.k8s.io/controlle-runtime模块实现。</p>
<p>在EdgeApplication资源同步中，由两个控制器负责实现，分别是 EdgeApplication controller 和 status controller。在 EdgeApplication Controller中，主要负责子资源的更新，同步EdgeApplication资源状态和子资源状态。在 status controller 中，主要负责子资源的状态同步到EdgeApplication 。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="c1">// Reconcile performs a full reconciliation for the object referred to by the Request.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The Controller will requeue the Request to be processed again if an error is non-nil or
</span></span></span><span class="line"><span class="cl"><span class="c1">// Result.Requeue is true, otherwise upon completion it will remove the work from the queue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Controller</span><span class="p">)</span> <span class="nf">Reconcile</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Reconciling EdgeApplication %s/%s&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">edgeApp</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">appsv1alpha1</span><span class="p">.</span><span class="nx">EdgeApplication</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">,</span> <span class="nx">edgeApp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// The resource may no longer exist, in which case we stop processing.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get edgeapplication %s/%s, %v&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">Requeue</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">edgeApp</span><span class="p">.</span><span class="nx">DeletionTimestamp</span><span class="p">.</span><span class="nf">IsZero</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// foreground cascade deletion of OwnerReference
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// will take the responsibility of removing created resources.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">syncEdgeApplication</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">edgeApp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>子资源状态同步：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">statusReconciler</span><span class="p">)</span> <span class="nf">Reconcile</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">edgeApp</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">appsv1alpha1</span><span class="p">.</span><span class="nx">EdgeApplication</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">,</span> <span class="nx">edgeApp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">apierrors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get edgeApp %s/%s, %v&#34;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">Requeue</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">edgeApp</span><span class="p">.</span><span class="nf">GetDeletionTimestamp</span><span class="p">().</span><span class="nf">IsZero</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nf">sync</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">edgeApp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>**流量闭环：**通过流量闭环的能力，将服务流量限制在同一节点组内，在一个节点组中访问service时，后端总是在同一个节点组中。当使用 EdgeApplication 中service Template 创建 service 时，会为 service 添上 service-topology：range-nodegroup 的 annotation。</p>
<p>kubeEdge 云上组件 CloudCore 会根据该 annotation 对 endpoint 和 endpoints slices 进行过滤，滤除不在同一节点组内的后端，之后再下发到边缘节点。</p>
<p>在 dynamic Controller 中，基于 K8s dynamic client 实现对 k8s 资源的 list-wath 。dynamic controller 逻辑在之前的课程中有介绍，这里重点介绍节点组流量过滤流程。</p>
<p>在 get/list 请求建立的短链接中，通过过滤 response 应答请求进行过滤。</p>
<p>过滤的资源包括 endpoint/endpointslice （后文统一以 endpoint代替），如果 endpoint 所属的 service 包含 annotation apps.kubeedge.io/service.topology:range-nodegroup ，则说明该资源需要过滤下发，根据 endpoint 关联的后端 pod 实例与目的节点是否属于同一个节点组，如果是，则下发，在下发的 endpoint中，只包含属于该节点的 pod IP 地址。最后的结果就是，节点组中的节点 listwath 到的endpoint 数据中只包含属于该节点组的 pod IP 地址，从而实现在该节点组中访问对应服务，流量只会转发到当前节点组中，从而避免跨节点组网络不通导致访问异常问题。</p>
<h3 id="cloudstreamedgestream-模块解读">Cloudstream/Edgestream 模块解读</h3>
<h4 id="功能说明-1">功能说明</h4>
<p>Cloudstream/Edgestream 实现边缘容器的运维功能，通过在云端和边缘节点同时开启 Cloudstream/Edgestream模块，实现logs/exec/metrics/stats能力</p>
<h4 id="整体概览-1">整体概览</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240220100305686.png"
        data-srcset="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240220100305686.png, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240220100305686.png 1.5x, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240220100305686.png 2x"
        data-sizes="auto"
        alt="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240220100305686.png"
        title="image-20240220100305686" /></p>
<h4 id="代码路径-1">代码路径</h4>
<ul>
<li>CloudStream：cloud/pkg/cloudstream</li>
<li>EdgeStream：edge/pkg/edgestream</li>
<li>公共代码：pkg/stream</li>
</ul>
<h4 id="cloudstream流程">CloudStream流程</h4>
<p>启动 Tunnel Server</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">TunnelServer</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nf">installDefaultHandler</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">cert</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">streamconfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Ca</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">data</span> <span class="p">=</span> <span class="nx">streamconfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Ca</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Succeed in loading TunnelCA from local directory&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">data</span> <span class="p">=</span> <span class="nx">hubconfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Ca</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Succeed in loading TunnelCA from CloudHub&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">pool</span> <span class="o">:=</span> <span class="nx">x509</span><span class="p">.</span><span class="nf">NewCertPool</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pool</span><span class="p">.</span><span class="nf">AppendCertsFromPEM</span><span class="p">(</span><span class="nx">pem</span><span class="p">.</span><span class="nf">EncodeToMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pem</span><span class="p">.</span><span class="nx">Block</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="nx">certutil</span><span class="p">.</span><span class="nx">CertificateBlockType</span><span class="p">,</span> <span class="nx">Bytes</span><span class="p">:</span> <span class="nx">data</span><span class="p">}))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">streamconfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Key</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">streamconfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Cert</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cert</span> <span class="p">=</span> <span class="nx">streamconfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Cert</span>
</span></span><span class="line"><span class="cl">		<span class="nx">key</span> <span class="p">=</span> <span class="nx">streamconfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Key</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Succeed in loading TunnelCert and Key from local directory&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cert</span> <span class="p">=</span> <span class="nx">hubconfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Cert</span>
</span></span><span class="line"><span class="cl">		<span class="nx">key</span> <span class="p">=</span> <span class="nx">hubconfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Key</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Succeed in loading TunnelCert and Key from CloudHub&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">certificate</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tls</span><span class="p">.</span><span class="nf">X509KeyPair</span><span class="p">(</span><span class="nx">pem</span><span class="p">.</span><span class="nf">EncodeToMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pem</span><span class="p">.</span><span class="nx">Block</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="nx">certutil</span><span class="p">.</span><span class="nx">CertificateBlockType</span><span class="p">,</span> <span class="nx">Bytes</span><span class="p">:</span> <span class="nx">cert</span><span class="p">}),</span> <span class="nx">pem</span><span class="p">.</span><span class="nf">EncodeToMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pem</span><span class="p">.</span><span class="nx">Block</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="s">&#34;PRIVATE KEY&#34;</span><span class="p">,</span> <span class="nx">Bytes</span><span class="p">:</span> <span class="nx">key</span><span class="p">}))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;Failed to load TLSTunnelCert and Key&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">tunnelServer</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Addr</span><span class="p">:</span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;:%d&#34;</span><span class="p">,</span> <span class="nx">streamconfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">TunnelPort</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Handler</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">container</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">TLSConfig</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ClientCAs</span><span class="p">:</span>    <span class="nx">pool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Certificates</span><span class="p">:</span> <span class="p">[]</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">{</span><span class="nx">certificate</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ClientAuth</span><span class="p">:</span>   <span class="nx">tls</span><span class="p">.</span><span class="nx">RequireAndVerifyClientCert</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">MinVersion</span><span class="p">:</span>   <span class="nx">tls</span><span class="p">.</span><span class="nx">VersionTLS12</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">CipherSuites</span><span class="p">:</span> <span class="p">[]</span><span class="kt">uint16</span><span class="p">{</span><span class="nx">tls</span><span class="p">.</span><span class="nx">TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Prepare to start tunnel server ...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="p">=</span> <span class="nx">tunnelServer</span><span class="p">.</span><span class="nf">ListenAndServeTLS</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Exitf</span><span class="p">(</span><span class="s">&#34;Start tunnelServer error %v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="edgestream-流程">EdgeStream 流程</h4>
<p>EdgeStream 模块启动后，连接云上 CloudStream。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">edgestream</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">serverURL</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">URL</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Scheme</span><span class="p">:</span> <span class="s">&#34;wss&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Host</span><span class="p">:</span>   <span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">TunnelServer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Path</span><span class="p">:</span>   <span class="s">&#34;/v1/kubeedge/connect&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// TODO: Will improve in the future
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">edgehub</span><span class="p">.</span><span class="nf">GetCertSyncChannel</span><span class="p">()[</span><span class="nx">e</span><span class="p">.</span><span class="nf">Name</span><span class="p">()];</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Exitf</span><span class="p">(</span><span class="s">&#34;Failed to find cert key pair&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cert</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tls</span><span class="p">.</span><span class="nf">LoadX509KeyPair</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">TLSTunnelCertFile</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">TLSTunnelPrivateKeyFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Exitf</span><span class="p">(</span><span class="s">&#34;Failed to load x509 key pair: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tlsConfig</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">InsecureSkipVerify</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Certificates</span><span class="p">:</span>       <span class="p">[]</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">{</span><span class="nx">cert</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ticker</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">ticker</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">beehiveContext</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ticker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">TLSClientConnect</span><span class="p">(</span><span class="nx">serverURL</span><span class="p">,</span> <span class="nx">tlsConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;TLSClientConnect error %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="节点与应用生命周期管理源码解析">节点与应用生命周期管理源码解析</h2>
<h3 id="edgecontroller">EdgeController</h3>
<p>EdgeController 是 Kubernetes API server和 EdgeCore 之间的桥梁，负责节点管理和应用状态数据云边协同。EdgeController映射的是一组核心 API 在云 和 边缘状态的同步，在实现上使用了两个内部 controller ，分别是处理上行消息 Upstream Controller和处理下行消息的 Downstream Controller</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240221084537350.png"
        data-srcset="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240221084537350.png, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240221084537350.png 1.5x, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240221084537350.png 2x"
        data-sizes="auto"
        alt="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240221084537350.png"
        title="image-20240221084537350" /></p>
<h3 id="edgecontroller模块注册与启动">EdgeController模块注册与启动</h3>
<p>EdgeController在 CloudCore 启动时发起注册，同样使用 beehive 框架注册 EdgeController 模块。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="nx">core</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nf">newEdgeController</span><span class="p">(</span><span class="nx">ec</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>EdgeController 的启动主要包括两个 controller 的启动，即上行消息控制器 Upstream Controller 和 下行消息控制器 Downstream controller 。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Start controller
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ec</span> <span class="o">*</span><span class="nx">EdgeController</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ec</span><span class="p">.</span><span class="nx">upstream</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Exitf</span><span class="p">(</span><span class="s">&#34;start upstream failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ec</span><span class="p">.</span><span class="nx">downstream</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Exitf</span><span class="p">(</span><span class="s">&#34;start downstream failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>下面依次查看两个消息控制器的启动与消息处理流程。</p>
<h4 id="upstream-controller">Upstream Controller</h4>
<p>上行消息主要指边缘 Edged向集群master发送的消息，主要包括 Edged 启动时注册node的消息，边缘上报的 nodestatus 与 podstatus 以及边缘发起的请求消息，譬如query secret 和 configmap 等。Upstream Controller 工作流程就是接收 cloud hub 发送的消息，根据不同的消息类型，对应地通过 kubeclient 访问 k8s 集群处理消息，并返回 response到边缘。</p>
<ol>
<li>Upstream 的创建与结构</li>
</ol>
<p>首先可以看下 Upstream 的结构定义，主要包括：</p>
<ul>
<li>KubeClient，用于访问 api-server，上报消息到k8s 集群或者 获取资源。</li>
<li>messageLayer，用于分发消息，主要包括Send/Receive/Response方法。</li>
<li>crdClient，在updateRuleStatus时用来更新crd。</li>
<li>消息 channel，各种类型的消息channel</li>
<li>lister,为各种消息资源创建的lister方法，用于处理对应消息的query请求。</li>
</ul>
<p>代码路径：cloud/pkg/edgecontroller/controller/upstream.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="c1">// UpstreamController subscribe messages from edge and sync to k8s api server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">UpstreamController</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">kubeClient</span>   <span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nx">messageLayer</span> <span class="nx">messagelayer</span><span class="p">.</span><span class="nx">MessageLayer</span>
</span></span><span class="line"><span class="cl">	<span class="nx">crdClient</span>    <span class="nx">crdClientset</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">config</span> <span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">EdgeController</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// message channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">nodeStatusChan</span>            <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">podStatusChan</span>             <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">secretChan</span>                <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">serviceAccountTokenChan</span>   <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">configMapChan</span>             <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">persistentVolumeChan</span>      <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">persistentVolumeClaimChan</span> <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">volumeAttachmentChan</span>      <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">queryNodeChan</span>             <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">createNodeChan</span>            <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">patchNodeChan</span>             <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">updateNodeChan</span>            <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">patchPodChan</span>              <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">podDeleteChan</span>             <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ruleStatusChan</span>            <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">createLeaseChan</span>           <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">queryLeaseChan</span>            <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">	<span class="nx">createPodChan</span>             <span class="kd">chan</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// lister
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">podLister</span>       <span class="nx">corelisters</span><span class="p">.</span><span class="nx">PodLister</span>
</span></span><span class="line"><span class="cl">	<span class="nx">configMapLister</span> <span class="nx">corelisters</span><span class="p">.</span><span class="nx">ConfigMapLister</span>
</span></span><span class="line"><span class="cl">	<span class="nx">secretLister</span>    <span class="nx">corelisters</span><span class="p">.</span><span class="nx">SecretLister</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nodeLister</span>      <span class="nx">corelisters</span><span class="p">.</span><span class="nx">NodeLister</span>
</span></span><span class="line"><span class="cl">	<span class="nx">leaseLister</span>     <span class="nx">coordinationlisters</span><span class="p">.</span><span class="nx">LeaseLister</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Upstream 启动</li>
</ol>
<p>Upstream 的启动过程主要由启动消息分发协程和启动各个消息处理协程组成。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="c1">// Start UpstreamController
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">uc</span> <span class="o">*</span><span class="nx">UpstreamController</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;start upstream controller&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">dispatchMessage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">UpdateNodeStatusWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">updateNodeStatus</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">UpdatePodStatusWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">updatePodStatus</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">QueryConfigMapWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">queryConfigMap</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">QuerySecretWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">querySecret</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">ServiceAccountTokenWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">processServiceAccountToken</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">QueryPersistentVolumeWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">queryPersistentVolume</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">QueryPersistentVolumeClaimWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">queryPersistentVolumeClaim</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">QueryVolumeAttachmentWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">queryVolumeAttachment</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">CreateNodeWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">registerNode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">PatchNodeWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">patchNode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">QueryNodeWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">queryNode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">UpdateNodeWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">updateNode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">PatchPodWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">patchPod</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">DeletePodWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">deletePod</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">CreateLeaseWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">createOrUpdateLease</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">QueryLeaseWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">queryLease</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">UpdateRuleStatusWorkers</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">updateRuleStatus</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">uc</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Load</span><span class="p">.</span><span class="nx">CreatePodWorks</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">uc</span><span class="p">.</span><span class="nf">createPod</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>消息分发</li>
</ol>
<p>消息分发操作步骤：</p>
<ul>
<li>由messageLayer的Receiver的方法接收上行消息（边缘通过cloudhub分发到edgecontroller的消息）</li>
<li>解析消息，获取消息的具体类型</li>
<li>根据消息类型，写入到对应的消息channel中</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">uc</span> <span class="o">*</span><span class="nx">UpstreamController</span><span class="p">)</span> <span class="nf">dispatchMessage</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">beehiveContext</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;stop dispatchMessage&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">uc</span><span class="p">.</span><span class="nx">messageLayer</span><span class="p">.</span><span class="nf">Receive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;receive message failed, %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;dispatch message ID: %s&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetID</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;dispatch message content: %+v&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">resourceType</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">messagelayer</span><span class="p">.</span><span class="nf">GetResourceType</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;parse message: %s resource type with error, message resource: %s, err: %v&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetResource</span><span class="p">(),</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;message: %s, operation type is: %s&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetOperation</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="nx">resourceType</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">ResourceTypeNodeStatus</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">uc</span><span class="p">.</span><span class="nx">nodeStatusChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">ResourceTypePodStatus</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">uc</span><span class="p">.</span><span class="nx">podStatusChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">ResourceTypeConfigmap</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">uc</span><span class="p">.</span><span class="nx">configMapChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">ResourceTypeSecret</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">uc</span><span class="p">.</span><span class="nx">secretChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">ResourceTypeServiceAccountToken</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">uc</span><span class="p">.</span><span class="nx">serviceAccountTokenChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">common</span><span class="p">.</span><span class="nx">ResourceTypePersistentVolume</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">uc</span><span class="p">.</span><span class="nx">persistentVolumeChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">common</span><span class="p">.</span><span class="nx">ResourceTypePersistentVolumeClaim</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">uc</span><span class="p">.</span><span class="nx">persistentVolumeClaimChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">common</span><span class="p">.</span><span class="nx">ResourceTypeVolumeAttachment</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">uc</span><span class="p">.</span><span class="nx">volumeAttachmentChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">ResourceTypeNode</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">switch</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetOperation</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">InsertOperation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">uc</span><span class="p">.</span><span class="nx">createNodeChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">QueryOperation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">uc</span><span class="p">.</span><span class="nx">queryNodeChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">UpdateOperation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">uc</span><span class="p">.</span><span class="nx">updateNodeChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">			<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;message: %s, operation type: %s unsupported&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetOperation</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">ResourceTypeNodePatch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">uc</span><span class="p">.</span><span class="nx">patchNodeChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">ResourceTypePodPatch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">uc</span><span class="p">.</span><span class="nx">patchPodChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">ResourceTypePod</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">switch</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetOperation</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">DeleteOperation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">uc</span><span class="p">.</span><span class="nx">podDeleteChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">InsertOperation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">uc</span><span class="p">.</span><span class="nx">createPodChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">			<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;message: %s, operation type: %s unsupported&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetOperation</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">ResourceTypeRuleStatus</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">uc</span><span class="p">.</span><span class="nx">ruleStatusChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">ResourceTypeLease</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">switch</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetOperation</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">InsertOperation</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">UpdateOperation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">uc</span><span class="p">.</span><span class="nx">createLeaseChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">QueryOperation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">uc</span><span class="p">.</span><span class="nx">queryLeaseChan</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;message: %s, resource type: %s unsupported&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="nx">resourceType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>消息处理</li>
</ol>
<p>edgecontroller目前支持处理的消息类型包括：</p>
<ul>
<li>registerNode（注册节点）/patchNode（更新Node）/queryNode（查询Node）/updateNodeStatus（更新node状态，V1.12之后已废弃）/updateNode（更新node，v1.12之后已废弃）</li>
<li>createOrUpdateLease（创建或更新node lease）/ queryLease (查询node lease)</li>
<li>patchPod （更新pod）/ deletePod （删除pod)/updatePodStatus（更新pod状态，v1.12之后已废弃）</li>
<li>processServiceAccouToken （获取serviceAccountToken）</li>
<li>queryXXX （获取configMap/Secret等资源）</li>
<li>updateRuleStatus（更新规则状态）</li>
</ul>
<p>本文以 patchNode 为例，详细介绍处理对应消息的流程，其他消息类型都与之类似。</p>
<p>消息处理步骤：</p>
<ol>
<li>起一个 for 循环，等待 patchNodeChan 里的消息，当dispatchMessage 函数写入到该channel，开始处理消息。</li>
<li>解析消息，获得namespace和node name</li>
<li>获取消息的内容，即边缘上报的patch内容</li>
<li>使用kubeclient直接调用patch方法更新node</li>
<li>将patchNode返回的response和error都塞入response的消息体内，调用messageLayer的Respose方法直接透传回边缘。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">uc</span> <span class="o">*</span><span class="nx">UpstreamController</span><span class="p">)</span> <span class="nf">patchNode</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">beehiveContext</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">&#34;stop patchNode&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">msg</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">uc</span><span class="p">.</span><span class="nx">patchNodeChan</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;message: %s, operation is: %s, and resource is %s&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetOperation</span><span class="p">(),</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetResource</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">namespace</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">messagelayer</span><span class="p">.</span><span class="nf">GetNamespace</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;message: %s process failure, get namespace failed with error: %v&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">name</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">messagelayer</span><span class="p">.</span><span class="nf">GetResourceName</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;message: %s process failure, get resource name failed with error: %v&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 直接用 patch 方法更新 k8s 中的节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">patchBytes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetContentData</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;message: %s process failure, get data failed with error: %v&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 直接把 k8s 的response 透传回边缘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">node</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">uc</span><span class="p">.</span><span class="nx">kubeClient</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">().</span><span class="nf">Nodes</span><span class="p">().</span><span class="nf">Patch</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">apimachineryType</span><span class="p">.</span><span class="nx">StrategicMergePatchType</span><span class="p">,</span> <span class="nx">patchBytes</span><span class="p">,</span> <span class="nx">metaV1</span><span class="p">.</span><span class="nx">PatchOptions</span><span class="p">{},</span> <span class="s">&#34;status&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;message: %s process failure, patch node failed with error: %v, namespace: %s, name: %s&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">			<span class="nx">resMsg</span> <span class="o">:=</span> <span class="nx">model</span><span class="p">.</span><span class="nf">NewMessage</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nf">GetID</span><span class="p">()).</span>
</span></span><span class="line"><span class="cl">				<span class="nf">SetResourceVersion</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">ResourceVersion</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">				<span class="nf">FillBody</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">edgeapi</span><span class="p">.</span><span class="nx">ObjectResp</span><span class="p">{</span><span class="nx">Object</span><span class="p">:</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">Err</span><span class="p">:</span> <span class="nx">err</span><span class="p">}).</span>
</span></span><span class="line"><span class="cl">				<span class="nf">BuildRouter</span><span class="p">(</span><span class="nx">modules</span><span class="p">.</span><span class="nx">EdgeControllerModuleName</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">GroupResource</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetResource</span><span class="p">(),</span> <span class="nx">model</span><span class="p">.</span><span class="nx">ResponseOperation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">uc</span><span class="p">.</span><span class="nx">messageLayer</span><span class="p">.</span><span class="nf">Response</span><span class="p">(</span><span class="o">*</span><span class="nx">resMsg</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;Message: %s process failure, response failed with error: %v&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;message: %s, patch node status successfully, namespace: %s, name: %s&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetID</span><span class="p">(),</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="downstream-controller">Downstream Controller</h4>
<p>下行消息控制器主要用于监听 k8s 事件，同步消息到边缘。在原生的k8s中，节点是直接通过list-watch来监听事件，并更新节点资源的。但是在负责的边缘场景中，边缘并不是直接通过HTTP访问云上，在 KubeEdge 中，云边协同是通过 websocket 进行通信的，所以就需要在云上通过 DownStream Controller 通过list-watch来监听实践，并且把更新的元数据同步到边缘。</p>
<p>Downstream 的结构主要包括：</p>
<ul>
<li>kubeclient ，用于访问k8s 集群</li>
<li>messageLayer ，分发消息</li>
<li>podManager 等，各个资源的管理器，主要用于监听对应资源的事件，在第二部分详细展开介绍。</li>
<li>lc，本地缓存，由多个map结构组成，key为各种资源类型</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="c1">// DownstreamController watch kubernetes api server and send change to edge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">DownstreamController</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">kubeClient</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">messageLayer</span> <span class="nx">messagelayer</span><span class="p">.</span><span class="nx">MessageLayer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">podManager</span> <span class="o">*</span><span class="nx">manager</span><span class="p">.</span><span class="nx">PodManager</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">configmapManager</span> <span class="o">*</span><span class="nx">manager</span><span class="p">.</span><span class="nx">ConfigMapManager</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">secretManager</span> <span class="o">*</span><span class="nx">manager</span><span class="p">.</span><span class="nx">SecretManager</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">nodeManager</span> <span class="o">*</span><span class="nx">manager</span><span class="p">.</span><span class="nx">NodesManager</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">rulesManager</span> <span class="o">*</span><span class="nx">manager</span><span class="p">.</span><span class="nx">RuleManager</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ruleEndpointsManager</span> <span class="o">*</span><span class="nx">manager</span><span class="p">.</span><span class="nx">RuleEndpointManager</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">lc</span> <span class="o">*</span><span class="nx">manager</span><span class="p">.</span><span class="nx">LocationCache</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">podLister</span> <span class="nx">clientgov1</span><span class="p">.</span><span class="nx">PodLister</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>DownStream 的创建过程主要包括各个资源管理器的创建以及本地缓存的初始化</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// NewDownstreamController create a DownstreamController from config
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewDownstreamController</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">EdgeController</span><span class="p">,</span> <span class="nx">k8sInformerFactory</span> <span class="nx">k8sinformers</span><span class="p">.</span><span class="nx">SharedInformerFactory</span><span class="p">,</span> <span class="nx">keInformerFactory</span> <span class="nx">informers</span><span class="p">.</span><span class="nx">KubeEdgeCustomInformer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">crdInformerFactory</span> <span class="nx">crdinformers</span><span class="p">.</span><span class="nx">SharedInformerFactory</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">DownstreamController</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">lc</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">manager</span><span class="p">.</span><span class="nx">LocationCache</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 创建各个资源类型对应的管理器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">podInformer</span> <span class="o">:=</span> <span class="nx">k8sInformerFactory</span><span class="p">.</span><span class="nf">Core</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">Pods</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">podManager</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">NewPodManager</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">podInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;create pod manager failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">configMapInformer</span> <span class="o">:=</span> <span class="nx">k8sInformerFactory</span><span class="p">.</span><span class="nf">Core</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">ConfigMaps</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">configMapManager</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">NewConfigMapManager</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">configMapInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;create configmap manager failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">secretInformer</span> <span class="o">:=</span> <span class="nx">k8sInformerFactory</span><span class="p">.</span><span class="nf">Core</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">Secrets</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">secretManager</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">NewSecretManager</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">secretInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;create secret manager failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nodeInformer</span> <span class="o">:=</span> <span class="nx">keInformerFactory</span><span class="p">.</span><span class="nf">EdgeNode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nodesManager</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">NewNodesManager</span><span class="p">(</span><span class="nx">nodeInformer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;Create nodes manager failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">rulesInformer</span> <span class="o">:=</span> <span class="nx">crdInformerFactory</span><span class="p">.</span><span class="nf">Rules</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">Rules</span><span class="p">().</span><span class="nf">Informer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rulesManager</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">NewRuleManager</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">rulesInformer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;Create rulesManager failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ruleEndpointsInformer</span> <span class="o">:=</span> <span class="nx">crdInformerFactory</span><span class="p">.</span><span class="nf">Rules</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">RuleEndpoints</span><span class="p">().</span><span class="nf">Informer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ruleEndpointsManager</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">NewRuleEndpointManager</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">ruleEndpointsInformer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;Create ruleEndpointsManager failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">dc</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">DownstreamController</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">kubeClient</span><span class="p">:</span>           <span class="nx">client</span><span class="p">.</span><span class="nf">GetKubeClient</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">podManager</span><span class="p">:</span>           <span class="nx">podManager</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">configmapManager</span><span class="p">:</span>     <span class="nx">configMapManager</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">secretManager</span><span class="p">:</span>        <span class="nx">secretManager</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">nodeManager</span><span class="p">:</span>          <span class="nx">nodesManager</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">messageLayer</span><span class="p">:</span>         <span class="nx">messagelayer</span><span class="p">.</span><span class="nf">EdgeControllerMessageLayer</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">lc</span><span class="p">:</span>                   <span class="nx">lc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">podLister</span><span class="p">:</span>            <span class="nx">podInformer</span><span class="p">.</span><span class="nf">Lister</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rulesManager</span><span class="p">:</span>         <span class="nx">rulesManager</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ruleEndpointsManager</span><span class="p">:</span> <span class="nx">ruleEndpointsManager</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 初始化缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">initLocating</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">dc</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>
<p>资源管理器</p>
<p>EdgeController 目前包括6种资源管理器，分别是PodManager、NodeManager、ConfigMapManager、SecretManager、RuleManager和RuleEndpointManager。本文以PodManager为例，详细介绍Downstream中的资源管理器。</p>
<p>PodManager中的主要包括两个Channel，realEvents表示从K8s watch到的实际pod事件，mergedEvents是根据KubeEdge自身需求，通过对 realEvents watch 到的事件进行预处理后再写入Channel。</p>
<p>注意事项：只有PodManager有两个Event Channel，其余资源的Manager都只有一个channel，用来监听K8s更新事件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// PodManager is a manager watch pod change event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">PodManager</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// events from watch kubernetes api server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">realEvents</span> <span class="kd">chan</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">Event</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// events merged
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">mergedEvents</span> <span class="kd">chan</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">Event</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>PodManager的创建包括了两个步骤，一个是运行ShareInformer，ShareInformer用于创建list-watch实例，注册事件监听，从而监听到集群中的pod的更新事件，第二步是起一个merge协程，用于对从 realEvents Channel监听到更新事件进行预处理，并写入mergeEvents Channel。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// NewPodManager create PodManager from config
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewPodManager</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">EdgeController</span><span class="p">,</span> <span class="nx">si</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">PodManager</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">realEvents</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">Event</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">PodEvent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mergedEvents</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">Event</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">PodEvent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rh</span> <span class="o">:=</span> <span class="nf">NewCommonResourceEventHandler</span><span class="p">(</span><span class="nx">realEvents</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">podEventFilter</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">si</span><span class="p">.</span><span class="nf">AddEventHandler</span><span class="p">(</span><span class="nx">rh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pm</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">PodManager</span><span class="p">{</span><span class="nx">realEvents</span><span class="p">:</span> <span class="nx">realEvents</span><span class="p">,</span> <span class="nx">mergedEvents</span><span class="p">:</span> <span class="nx">mergedEvents</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">pm</span><span class="p">.</span><span class="nf">merge</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">pm</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>Downstream  Controller 的启动</li>
</ol>
</li>
</ol>
<p>Downstream  Controller 的启动即启动各个资源同步函数的协程</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Start DownstreamController
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">dc</span> <span class="o">*</span><span class="nx">DownstreamController</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;start downstream controller&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// pod
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">syncPod</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// configmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">syncConfigMap</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// secret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">syncSecret</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// nodes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">syncEdgeNodes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// rule
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">syncRule</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ruleendpoint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">syncRuleEndpoint</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>资源同步</li>
</ol>
<p>同样以syncPod为例，介绍一下资源同步到边缘的步骤。SyncPod函数同样起了一个for循环，始终监听PodManager中的mergedEvents Channel。</p>
<ul>
<li>当有pod更新事件发生时，从Channel中读出事件</li>
<li>解析事件，从中获取新的podfd</li>
<li>根据pod中的nodename，namespace等信息，构建下行消息。</li>
<li>根据事件类型（Added/Deleted/Modified），设置下行消息的操作类型，并更新本地缓存</li>
<li>发送消息到边缘</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">dc</span> <span class="o">*</span><span class="nx">DownstreamController</span><span class="p">)</span> <span class="nf">syncPod</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">beehiveContext</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">&#34;Stop edgecontroller downstream syncPod loop&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 监听到 pod 更新事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">case</span> <span class="nx">e</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">dc</span><span class="p">.</span><span class="nx">podManager</span><span class="p">.</span><span class="nf">Events</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 解析 event 获得事件中的pod
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">pod</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Object</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;object type: %T unsupported&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">dc</span><span class="p">.</span><span class="nx">lc</span><span class="p">.</span><span class="nf">IsEdgeNode</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 构建下行消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">resource</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">messagelayer</span><span class="p">.</span><span class="nf">BuildResource</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">NodeName</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">ResourceTypePod</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;built message resource failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">msg</span> <span class="o">:=</span> <span class="nx">model</span><span class="p">.</span><span class="nf">NewMessage</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">				<span class="nf">SetResourceVersion</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">ResourceVersion</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">				<span class="nf">FillBody</span><span class="p">(</span><span class="nx">pod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 根据事件类型，设置下行消息的router，并更新缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">switch</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Type</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">Added</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">msg</span><span class="p">.</span><span class="nf">BuildRouter</span><span class="p">(</span><span class="nx">modules</span><span class="p">.</span><span class="nx">EdgeControllerModuleName</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">GroupResource</span><span class="p">,</span> <span class="nx">resource</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">InsertOperation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nx">dc</span><span class="p">.</span><span class="nx">lc</span><span class="p">.</span><span class="nf">AddOrUpdatePod</span><span class="p">(</span><span class="o">*</span><span class="nx">pod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">Deleted</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">msg</span><span class="p">.</span><span class="nf">BuildRouter</span><span class="p">(</span><span class="nx">modules</span><span class="p">.</span><span class="nx">EdgeControllerModuleName</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">GroupResource</span><span class="p">,</span> <span class="nx">resource</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">DeleteOperation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">Modified</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">msg</span><span class="p">.</span><span class="nf">BuildRouter</span><span class="p">(</span><span class="nx">modules</span><span class="p">.</span><span class="nx">EdgeControllerModuleName</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">GroupResource</span><span class="p">,</span> <span class="nx">resource</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">UpdateOperation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nx">dc</span><span class="p">.</span><span class="nx">lc</span><span class="p">.</span><span class="nf">AddOrUpdatePod</span><span class="p">(</span><span class="o">*</span><span class="nx">pod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;pod event type: %s unsupported&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 发送消息到边缘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dc</span><span class="p">.</span><span class="nx">messageLayer</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="o">*</span><span class="nx">msg</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;send message failed with error: %s, operation: %s, resource: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetOperation</span><span class="p">(),</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetResource</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;send message successfully, operation: %s, resource: %s&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetOperation</span><span class="p">(),</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetResource</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="metamanager">MetaManager</h3>
<p>MetaManager 作为Edgehub与Edged消息交互的桥梁，不仅仅负责消息转发，更重要的是将元数据保存在边缘数据库中，当边云连接断开时，可以保障边缘业务稳定运行，尤其是当边缘节点重启时，Edged可以直接通过MetaManager从数据库读取元数据，保证边缘业务的快速恢复，达到边缘自治的能力。</p>
<p>本文仅介绍metaManager处理元数据的流程</p>
<p>metamanager启动时 会起一个处理数据的process协程，在协程中启动一个for循环,在循环中接收消息，并对消息进行处理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">metaManager</span><span class="p">)</span> <span class="nf">runMetaManager</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">beehiveContext</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">&#34;MetaManager main loop stop&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 接收消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">beehiveContext</span><span class="p">.</span><span class="nf">Receive</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nf">Name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;get a message %+v: %v&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;get a message %+v&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 处理消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">m</span><span class="p">.</span><span class="nf">process</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>MetaManager 会根据消息操作类型，做出对应的处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">metaManager</span><span class="p">)</span> <span class="nf">process</span><span class="p">(</span><span class="nx">message</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">operation</span> <span class="o">:=</span> <span class="nx">message</span><span class="p">.</span><span class="nf">GetOperation</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="nx">operation</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">InsertOperation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nf">processInsert</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">UpdateOperation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nf">processUpdate</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">PatchOperation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nf">processPatch</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">DeleteOperation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nf">processDelete</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">QueryOperation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nf">processQuery</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">model</span><span class="p">.</span><span class="nx">ResponseOperation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nf">processResponse</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">CSIOperationTypeCreateVolume</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">constants</span><span class="p">.</span><span class="nx">CSIOperationTypeDeleteVolume</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">constants</span><span class="p">.</span><span class="nx">CSIOperationTypeControllerPublishVolume</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">constants</span><span class="p">.</span><span class="nx">CSIOperationTypeControllerUnpublishVolume</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nf">processVolume</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;metamanager not supported operation: %v&#34;</span><span class="p">,</span> <span class="nx">operation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以Insert为例，MetaManager 接收到消息之后，会解析出消息的内容以及 resourceKey (一般为{namespace}/{restype}/{resld}结构)和type，并将其保存到边缘数据库。之后会根据消息的具体信息，包括源模块、消息类型等，将消息转发至目的模块。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">metaManager</span><span class="p">)</span> <span class="nf">processInsert</span><span class="p">(</span><span class="nx">message</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">imitator</span><span class="p">.</span><span class="nx">DefaultV2Client</span><span class="p">.</span><span class="nf">Inject</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">msgSource</span> <span class="o">:=</span> <span class="nx">message</span><span class="p">.</span><span class="nf">GetSource</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">msgSource</span> <span class="o">==</span> <span class="nx">modules</span><span class="p">.</span><span class="nx">EdgedModuleName</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">connect</span><span class="p">.</span><span class="nf">IsConnected</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;process remote failed, req[%s], err: %v&#34;</span><span class="p">,</span> <span class="nf">msgDebugInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">message</span><span class="p">),</span> <span class="nx">errNotConnected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nf">feedbackError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to process remote: %s&#34;</span><span class="p">,</span> <span class="nx">errNotConnected</span><span class="p">),</span> <span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nf">processRemote</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">handleMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">message</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">feedbackError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">msgSource</span> <span class="o">==</span> <span class="nx">cloudmodules</span><span class="p">.</span><span class="nx">DeviceControllerModuleName</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">message</span><span class="p">.</span><span class="nf">SetRoute</span><span class="p">(</span><span class="nx">modules</span><span class="p">.</span><span class="nx">MetaGroup</span><span class="p">,</span> <span class="nx">modules</span><span class="p">.</span><span class="nx">DeviceTwinModuleName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">beehiveContext</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="nx">modules</span><span class="p">.</span><span class="nx">DeviceTwinModuleName</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">msgSource</span> <span class="o">!=</span> <span class="nx">cloudmodules</span><span class="p">.</span><span class="nx">PolicyControllerModuleName</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Notify edged
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">sendToEdged</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">message</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">resp</span> <span class="o">:=</span> <span class="nx">message</span><span class="p">.</span><span class="nf">NewRespByMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">message</span><span class="p">,</span> <span class="nx">OK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">sendToCloud</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="edged">Edged</h3>
<p>本文以新版Edged（v1.12之后）为例，新版直接在Edged中集成了裁剪之后的kubelet，所以在后面的功能模块源码解析中会涉及一部分的kubelet代码，有关kubelet源码更详细的解读还需要大家提前学习下Kubernetes。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240301153020014.png"
        data-srcset="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240301153020014.png, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240301153020014.png 1.5x, https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240301153020014.png 2x"
        data-sizes="auto"
        alt="https://zhuyaguang-1308110266.cos.ap-shanghai.myqcloud.com/img/image-20240301153020014.png"
        title="image-20240301153020014" /></p>
<p>关于Edged模块的源码解析，我们会从三个部分进行，分别是Edged的注册与启动、Edged上报消息链路和下行消息处理链路。</p>
<h4 id="edged的注册与启动">Edged的注册与启动</h4>
<p>Edged 模块的注册同样是调用 beehive 框架公共方法来注册模块，这里的主要工作是完成Edged的创建。</p>
<p>Edged的创建主要工作包括：</p>
<ol>
<li>参数的初始化，由于新版Edged直接集成kubelet，所以需要先把Edged的参数转换成kubelet启动所需的参数。Kubelet的启动涉及两类参数，KubeletConfiguration 和KubeletFlags，所以这里通过两个参数转换函数将Edged的参数转换为kubelet的启动参数。</li>
<li>调用UnsecureDependencies函数初始化一些运行时所需的参数</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="c1">// newEdged creates new edged object and initialises it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newEdged</span><span class="p">(</span><span class="nx">enable</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">nodeName</span><span class="p">,</span> <span class="nx">namespace</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">edged</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">ed</span> <span class="o">*</span><span class="nx">edged</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">enable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">edged</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">enable</span><span class="p">:</span>    <span class="nx">enable</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">nodeName</span><span class="p">:</span>  <span class="nx">nodeName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">namespace</span><span class="p">:</span> <span class="nx">namespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// initial kubelet config and flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">kubeletConfig</span> <span class="nx">kubeletconfig</span><span class="p">.</span><span class="nx">KubeletConfiguration</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">kubeletFlags</span> <span class="nx">kubeletoptions</span><span class="p">.</span><span class="nx">KubeletFlags</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="p">=</span> <span class="nx">edgedconfig</span><span class="p">.</span><span class="nf">ConvertEdgedKubeletConfigurationToConfigKubeletConfiguration</span><span class="p">(</span><span class="nx">edgedconfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">TailoredKubeletConfig</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">edgedconfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">TailoredKubeletFlag</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">kubeletConfig</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">ErrorS</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to convert kubelet config&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to construct kubelet configuration&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">edgedconfig</span><span class="p">.</span><span class="nf">ConvertConfigEdgedFlagToConfigKubeletFlag</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">edgedconfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">TailoredKubeletFlag</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">kubeletFlags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Set Kubelet RegisterNode Parameter in KubeletConfiguration.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// The parameter `registerNode` has been migrated to Kubelet Configuration.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// `registerNode` in KubeletFlag will be retained for next version(1.13), and removed in 1.14 and later.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">edgedconfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">RegisterNode</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">kubeletConfig</span><span class="p">.</span><span class="nx">RegisterNode</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// set feature gates from initial flags-based config
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultMutableFeatureGate</span><span class="p">.</span><span class="nf">SetFromMap</span><span class="p">(</span><span class="nx">kubeletConfig</span><span class="p">.</span><span class="nx">FeatureGates</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to set feature gates from initial flags-based config: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// construct a KubeletServer from kubeletFlags and kubeletConfig
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">kubeletServer</span> <span class="o">:=</span> <span class="nx">kubeletoptions</span><span class="p">.</span><span class="nx">KubeletServer</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">KubeletFlags</span><span class="p">:</span>         <span class="nx">kubeletFlags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">KubeletConfiguration</span><span class="p">:</span> <span class="nx">kubeletConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// make directory for static pod
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">kubeletConfig</span><span class="p">.</span><span class="nx">StaticPodPath</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">kubeletConfig</span><span class="p">.</span><span class="nx">StaticPodPath</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">ModePerm</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;create %s static pod path failed: %v&#34;</span><span class="p">,</span> <span class="nx">kubeletConfig</span><span class="p">.</span><span class="nx">StaticPodPath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">ErrorS</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;static pod path is nil!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// set edged version
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">nodestatus</span><span class="p">.</span><span class="nx">KubeletVersion</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s-kubeedge-%s&#34;</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">CurrentSupportK8sVersion</span><span class="p">,</span> <span class="nx">version</span><span class="p">.</span><span class="nf">Get</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// use kubeletServer to construct the default KubeletDeps
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">kubeletDeps</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">DefaultKubeletDeps</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">kubeletServer</span><span class="p">,</span> <span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">ErrorS</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to construct kubelet dependencies&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to construct kubelet dependencies&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">MakeKubeClientBridge</span><span class="p">(</span><span class="nx">kubeletDeps</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// source of all configuration
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">kubeletDeps</span><span class="p">.</span><span class="nx">PodConfig</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">NewPodConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">PodConfigNotificationIncremental</span><span class="p">,</span> <span class="nx">kubeletDeps</span><span class="p">.</span><span class="nx">Recorder</span><span class="p">,</span> <span class="nx">kubeletDeps</span><span class="p">.</span><span class="nx">PodStartupLatencyTracker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ed</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">edged</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">enable</span><span class="p">:</span>        <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">context</span><span class="p">:</span>       <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">KubeletServer</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">kubeletServer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">KubeletDeps</span><span class="p">:</span>   <span class="nx">kubeletDeps</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">FeatureGate</span><span class="p">:</span>   <span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">nodeName</span><span class="p">:</span>      <span class="nx">nodeName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">namespace</span><span class="p">:</span>     <span class="nx">namespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">ed</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>MakeKubeClientBridge ,新建metaClient，替换原生Kubelet里的KubeClient。原生Kubelet通过KubeClient访问apiserver上报节点消息，在KubeEdge中，通过这层替换，Kubelet会通过metaClient上报消息到 MetaManager，进而通过Websocket链路上报到云上。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="line"><span class="cl"><span class="c1">// MakeKubeClientBridge make kubeclient bridge to replace kubeclient with metaclient
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">MakeKubeClientBridge</span><span class="p">(</span><span class="nx">kubeletDeps</span> <span class="o">*</span><span class="nx">kubelet</span><span class="p">.</span><span class="nx">Dependencies</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span> <span class="o">:=</span> <span class="nx">kubebridge</span><span class="p">.</span><span class="nf">NewSimpleClientset</span><span class="p">(</span><span class="nx">metaclient</span><span class="p">.</span><span class="nf">New</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">kubeletDeps</span><span class="p">.</span><span class="nx">KubeClient</span> <span class="p">=</span> <span class="nx">client</span>
</span></span><span class="line"><span class="cl">	<span class="nx">kubeletDeps</span><span class="p">.</span><span class="nx">EventClient</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="nx">kubeletDeps</span><span class="p">.</span><span class="nx">HeartbeatClient</span> <span class="p">=</span> <span class="nx">client</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>NewPodConfig  ,用于新建kubelet启动所需的PodConfig，用于之后下行的pod消息写入。</li>
</ol>
<p>Edged的启动过程比较简单，直接通过调用 kubelet的启动函数即可。syncPod函数用于处理下行的Pod消息，在之后的第三部分会详细介绍。</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2024-03-21</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/kubeedge-code/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://zhuyaguang.github.io/kubeedge-code/" data-title="Kubeedge 代码解析（更新中）" data-via="SurfingSnail"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://zhuyaguang.github.io/kubeedge-code/"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="https://zhuyaguang.github.io/kubeedge-code/" data-title="Kubeedge 代码解析（更新中）" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://zhuyaguang.github.io/kubeedge-code/" data-title="Kubeedge 代码解析（更新中）"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://zhuyaguang.github.io/kubeedge-code/" data-title="Kubeedge 代码解析（更新中）"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Myspace" data-sharer="myspace" data-url="https://zhuyaguang.github.io/kubeedge-code/" data-title="Kubeedge 代码解析（更新中）" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="javascript:void(0);" title="分享到 Blogger" data-sharer="blogger" data-url="https://zhuyaguang.github.io/kubeedge-code/" data-title="Kubeedge 代码解析（更新中）" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://zhuyaguang.github.io/kubeedge-code/" data-title="Kubeedge 代码解析（更新中）"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/claude/" class="prev" rel="prev" title="无需魔法，快来体验 Claude 3 ，GPT 4在他面前就是弟弟"><i class="fas fa-angle-left fa-fw"></i>无需魔法，快来体验 Claude 3 ，GPT 4在他面前就是弟弟</a>
            <a href="/jetson-on-kubeedge-use-gpu/" class="next" rel="next" title="基于 Jetson 在 kubeedge上 搭建 机器学习环境（docker/containerd）">基于 Jetson 在 kubeedge上 搭建 机器学习环境（docker/containerd）<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022 - 2024</span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
            
            <script async src="https://www.googletagmanager.com/gtag/js?id=G-9ZMX6LNNGD"></script>
            <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-9ZMX6LNNGD');
            </script>
        </div>
        
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
